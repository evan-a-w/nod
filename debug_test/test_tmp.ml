open! Core
open! Import

let map_function_roots ~f functions =
  Map.map ~f:(Function.map_root ~f) functions
;;

let test_cfg s =
  s
  |> Parser.parse_string
  |> Result.map ~f:(map_function_roots ~f:Cfg.process)
  |> function
  | Error e -> Nod_error.to_string e |> print_endline
  | Ok fns ->
    Map.iter
      fns
      ~f:(fun { Function.root = ~root:_, ~blocks:_, ~in_order:blocks; _ } ->
        Vec.iter blocks ~f:(fun block ->
          let instrs =
            Vec.to_list block.Block.instructions @ [ block.terminal ]
          in
          print_s [%message block.id_hum (instrs : Ir.t list)]))
;;

let test_ssa ?don't_opt s =
  test_cfg s;
  print_endline "=================================";
  Parser.parse_string s
  |> Result.map ~f:(map_function_roots ~f:Cfg.process)
  |> Result.map ~f:Eir.set_entry_block_args
  |> Result.map ~f:(map_function_roots ~f:Ssa.create)
  |> function
  | Error e -> Nod_error.to_string e |> print_endline
  | Ok fns ->
    let go fns =
      Map.iter fns ~f:(fun { Function.root = (ssa : Ssa.t); _ } ->
        Vec.iter ssa.in_order ~f:(fun block ->
          let instrs = Vec.to_list block.instructions @ [ block.terminal ] in
          print_s
            [%message
              block.id_hum ~args:(block.args : Var.t Vec.t) (instrs : Ir.t list)]))
    in
    go fns;
    (match don't_opt with
     | Some () -> ()
     | None ->
       print_endline "******************************";
       Eir.optimize fns;
       go fns)
;;

let compile_and_lower ?(opt_flags = Eir.Opt_flags.no_opt) program =
  match Nod.compile ~opt_flags program with
  | Error e -> Nod_error.to_string e |> print_endline
  | Ok functions ->
    let asm = X86_backend.compile_to_asm functions in
    print_endline asm

let borked = Examples.Textual.sum_100

let%expect_test "borked" =
  compile_and_lower ~opt_flags:Eir.Opt_flags.default borked;
  [%expect
    {|
    .intel_syntax noprefix
    .text
    .globl root
    root:
      push rbp
      push r13
      push r14
      push r15
      mov rbp, rsp
      add rbp, 32
      jmp root__start
    root__start:
      mov r15, 1
      mov r14, 0
      jmp root__check
    root__check:
      mov r13, r15
      sub r13, 100
      cmp r13, 0
      jne root__intermediate_check_to_body
      jmp root__intermediate_check_to_exit
    root__intermediate_check_to_body:
      jmp root__body
    root__body:
      add r14, r15
      mov r13, 1
      add r13, r15
      mov r15, r13
      jmp root__check
    root__intermediate_check_to_exit:
      mov r15, r14
      jmp root__exit
    root__exit:
      mov rax, r15
      jmp root__root__epilogue
    root__root__epilogue:
      mov rsp, rbp
      sub rsp, 32
      pop r15
      pop r14
      pop r13
      pop rbp
      ret
    .section .note.GNU-stack,"",@progbits
    |}]
;;


let%expect_test "debug borked opt ssa" = test_ssa borked;
  [%expect {|
    (start
     (instrs
      ((Move ((name i) (type_ I64)) (Lit 1))
       (Move ((name sum) (type_ I64)) (Lit 0))
       (Branch
        (Cond (cond (Lit 1))
         (if_true ((block ((id_hum check) (args ()))) (args ())))
         (if_false ((block ((id_hum exit) (args ()))) (args ()))))))))
    (check
     (instrs
      ((Sub
        ((dest ((name cond) (type_ I64))) (src1 (Var ((name i) (type_ I64))))
         (src2 (Lit 100))))
       (Branch
        (Cond (cond (Var ((name cond) (type_ I64))))
         (if_true ((block ((id_hum body) (args ()))) (args ())))
         (if_false ((block ((id_hum exit) (args ()))) (args ()))))))))
    (body
     (instrs
      ((Add
        ((dest ((name sum) (type_ I64))) (src1 (Var ((name sum) (type_ I64))))
         (src2 (Var ((name i) (type_ I64))))))
       (Add
        ((dest ((name i) (type_ I64))) (src1 (Var ((name i) (type_ I64))))
         (src2 (Lit 1))))
       (Branch
        (Cond (cond (Lit 1))
         (if_true ((block ((id_hum check) (args ()))) (args ())))
         (if_false ((block ((id_hum exit) (args ()))) (args ()))))))))
    (exit (instrs ((Return (Var ((name sum) (type_ I64)))))))
    =================================
    (start (args ())
     (instrs
      ((Move ((name i) (type_ I64)) (Lit 1))
       (Move ((name sum) (type_ I64)) (Lit 0))
       (Branch
        (Cond (cond (Lit 1))
         (if_true
          ((block
            ((id_hum check)
             (args (((name i%1) (type_ I64)) ((name sum%1) (type_ I64))))))
           (args (((name i) (type_ I64)) ((name sum) (type_ I64))))))
         (if_false
          ((block
            ((id_hum exit)
             (args (((name i%0) (type_ I64)) ((name sum%0) (type_ I64))))))
           (args (((name i) (type_ I64)) ((name sum) (type_ I64)))))))))))
    (check (args (((name i%1) (type_ I64)) ((name sum%1) (type_ I64))))
     (instrs
      ((Sub
        ((dest ((name cond) (type_ I64))) (src1 (Var ((name i%1) (type_ I64))))
         (src2 (Lit 100))))
       (Branch
        (Cond (cond (Var ((name cond) (type_ I64))))
         (if_true ((block ((id_hum body) (args ()))) (args ())))
         (if_false
          ((block
            ((id_hum exit)
             (args (((name i%0) (type_ I64)) ((name sum%0) (type_ I64))))))
           (args (((name i%1) (type_ I64)) ((name sum%1) (type_ I64)))))))))))
    (body (args ())
     (instrs
      ((Add
        ((dest ((name sum%2) (type_ I64)))
         (src1 (Var ((name sum%1) (type_ I64))))
         (src2 (Var ((name i%1) (type_ I64))))))
       (Add
        ((dest ((name i%2) (type_ I64))) (src1 (Var ((name i%1) (type_ I64))))
         (src2 (Lit 1))))
       (Branch
        (Cond (cond (Lit 1))
         (if_true
          ((block
            ((id_hum check)
             (args (((name i%1) (type_ I64)) ((name sum%1) (type_ I64))))))
           (args (((name i%2) (type_ I64)) ((name sum%2) (type_ I64))))))
         (if_false
          ((block
            ((id_hum exit)
             (args (((name i%0) (type_ I64)) ((name sum%0) (type_ I64))))))
           (args (((name i%2) (type_ I64)) ((name sum%2) (type_ I64)))))))))))
    (exit (args (((name i%0) (type_ I64)) ((name sum%0) (type_ I64))))
     (instrs ((Return (Var ((name sum%0) (type_ I64)))))))
    ******************************
    (start (args ())
     (instrs
      ((Move ((name i) (type_ I64)) (Lit 1))
       (Move ((name sum) (type_ I64)) (Lit 0))
       (Branch
        (Uncond
         ((block
           ((id_hum check)
            (args (((name i%1) (type_ I64)) ((name sum%1) (type_ I64))))))
          (args (((name i) (type_ I64)) ((name sum) (type_ I64))))))))))
    (check (args (((name i%1) (type_ I64)) ((name sum%1) (type_ I64))))
     (instrs
      ((Sub
        ((dest ((name cond) (type_ I64))) (src1 (Var ((name i%1) (type_ I64))))
         (src2 (Lit 100))))
       (Branch
        (Cond (cond (Var ((name cond) (type_ I64))))
         (if_true ((block ((id_hum body) (args ()))) (args ())))
         (if_false
          ((block ((id_hum exit) (args (((name sum%0) (type_ I64))))))
           (args (((name sum%1) (type_ I64)))))))))))
    (body (args ())
     (instrs
      ((Add
        ((dest ((name sum%2) (type_ I64)))
         (src1 (Var ((name sum%1) (type_ I64))))
         (src2 (Var ((name i%1) (type_ I64))))))
       (Add
        ((dest ((name i%2) (type_ I64))) (src1 (Lit 1))
         (src2 (Var ((name i%1) (type_ I64))))))
       (Branch
        (Uncond
         ((block
           ((id_hum check)
            (args (((name i%1) (type_ I64)) ((name sum%1) (type_ I64))))))
          (args (((name i%2) (type_ I64)) ((name sum%2) (type_ I64))))))))))
    (exit (args (((name sum%0) (type_ I64))))
     (instrs ((Return (Var ((name sum%0) (type_ I64)))))))
    |}]


let%expect_test "debug borked" =
  match Nod.compile ~opt_flags:Eir.Opt_flags.no_opt borked with
  | Error e -> Nod_error.to_string e |> print_endline
  | Ok functions ->
    X86_backend.For_testing.print_selected_instructions functions;
    [%expect
      {|
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | block | instruction                                                                                                                                                                                                                                                                                                                     | live_in                                                                    | live_out                                                                   |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | start | (block start(args()))                                                                                                                                                                                                                                                                                                           | {}                                                                         | {}                                                                         |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | start | (Move((name i)(type_ I64))(Lit 1))                                                                                                                                                                                                                                                                                              | {}                                                                         | (((name i)(type_ I64)))                                                    |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | start | (Move((name sum)(type_ I64))(Lit 0))                                                                                                                                                                                                                                                                                            | (((name i)(type_ I64)))                                                    | (((name i)(type_ I64))((name sum)(type_ I64)))                             |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | start | (Branch(Cond(cond(Lit 1))(if_true((block((id_hum check)(args(((name i%1)(type_ I64))((name sum%1)(type_ I64))))))(args(((name i)(type_ I64))((name sum)(type_ I64))))))(if_false((block((id_hum exit)(args(((name i%0)(type_ I64))((name sum%0)(type_ I64))))))(args(((name i)(type_ I64))((name sum)(type_ I64))))))))         | (((name i)(type_ I64))((name sum)(type_ I64)))                             | {}                                                                         |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | start | block end                                                                                                                                                                                                                                                                                                                       | {}                                                                         | {}                                                                         |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | check | (block start(args(((name i%1)(type_ I64))((name sum%1)(type_ I64)))))                                                                                                                                                                                                                                                           | {}                                                                         | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | check | (Sub((dest((name cond)(type_ I64)))(src1(Var((name i%1)(type_ I64))))(src2(Lit 100))))                                                                                                                                                                                                                                          | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         | (((name i%1)(type_ I64))((name cond)(type_ I64))((name sum%1)(type_ I64))) |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | check | (Branch(Cond(cond(Var((name cond)(type_ I64))))(if_true((block((id_hum body)(args())))(args())))(if_false((block((id_hum exit)(args(((name i%0)(type_ I64))((name sum%0)(type_ I64))))))(args(((name i%1)(type_ I64))((name sum%1)(type_ I64))))))))                                                                            | (((name i%1)(type_ I64))((name cond)(type_ I64))((name sum%1)(type_ I64))) | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | check | block end                                                                                                                                                                                                                                                                                                                       | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | body  | (block start(args()))                                                                                                                                                                                                                                                                                                           | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | body  | (Add((dest((name sum%2)(type_ I64)))(src1(Var((name sum%1)(type_ I64))))(src2(Var((name i%1)(type_ I64))))))                                                                                                                                                                                                                    | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         | (((name i%1)(type_ I64))((name sum%2)(type_ I64)))                         |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | body  | (Add((dest((name i%2)(type_ I64)))(src1(Var((name i%1)(type_ I64))))(src2(Lit 1))))                                                                                                                                                                                                                                             | (((name i%1)(type_ I64))((name sum%2)(type_ I64)))                         | (((name sum%2)(type_ I64))((name i%2)(type_ I64)))                         |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | body  | (Branch(Cond(cond(Lit 1))(if_true((block((id_hum check)(args(((name i%1)(type_ I64))((name sum%1)(type_ I64))))))(args(((name i%2)(type_ I64))((name sum%2)(type_ I64))))))(if_false((block((id_hum exit)(args(((name i%0)(type_ I64))((name sum%0)(type_ I64))))))(args(((name i%2)(type_ I64))((name sum%2)(type_ I64)))))))) | (((name sum%2)(type_ I64))((name i%2)(type_ I64)))                         | {}                                                                         |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | body  | block end                                                                                                                                                                                                                                                                                                                       | {}                                                                         | {}                                                                         |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | exit  | (block start(args(((name i%0)(type_ I64))((name sum%0)(type_ I64)))))                                                                                                                                                                                                                                                           | {}                                                                         | (((name sum%0)(type_ I64)))                                                |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | exit  | (Return(Var((name sum%0)(type_ I64))))                                                                                                                                                                                                                                                                                          | (((name sum%0)(type_ I64)))                                                | {}                                                                         |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | exit  | block end                                                                                                                                                                                                                                                                                                                       | {}                                                                         | {}                                                                         |
      +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      |}]
;;


let%expect_test "debug borked opt" =
  match Nod.compile ~opt_flags:Eir.Opt_flags.default borked with
  | Error e -> Nod_error.to_string e |> print_endline
  | Ok functions ->
    X86_backend.For_testing.print_selected_instructions functions;
    [%expect
      {|
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | block | instruction                                                                                                                                                                                            | live_in                                                                    | live_out                                                                   |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | start | (block start(args()))                                                                                                                                                                                  | {}                                                                         | {}                                                                         |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | start | (Move((name i)(type_ I64))(Lit 1))                                                                                                                                                                     | {}                                                                         | (((name i)(type_ I64)))                                                    |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | start | (Move((name sum)(type_ I64))(Lit 0))                                                                                                                                                                   | (((name i)(type_ I64)))                                                    | (((name i)(type_ I64))((name sum)(type_ I64)))                             |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | start | (Branch(Uncond((block((id_hum check)(args(((name i%1)(type_ I64))((name sum%1)(type_ I64))))))(args(((name i)(type_ I64))((name sum)(type_ I64)))))))                                                  | (((name i)(type_ I64))((name sum)(type_ I64)))                             | {}                                                                         |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | start | block end                                                                                                                                                                                              | {}                                                                         | {}                                                                         |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | check | (block start(args(((name i%1)(type_ I64))((name sum%1)(type_ I64)))))                                                                                                                                  | {}                                                                         | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | check | (Sub((dest((name cond)(type_ I64)))(src1(Var((name i%1)(type_ I64))))(src2(Lit 100))))                                                                                                                 | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         | (((name i%1)(type_ I64))((name cond)(type_ I64))((name sum%1)(type_ I64))) |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | check | (Branch(Cond(cond(Var((name cond)(type_ I64))))(if_true((block((id_hum body)(args())))(args())))(if_false((block((id_hum exit)(args(((name sum%0)(type_ I64))))))(args(((name sum%1)(type_ I64)))))))) | (((name i%1)(type_ I64))((name cond)(type_ I64))((name sum%1)(type_ I64))) | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | check | block end                                                                                                                                                                                              | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | body  | (block start(args()))                                                                                                                                                                                  | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | body  | (Add((dest((name sum%2)(type_ I64)))(src1(Var((name sum%1)(type_ I64))))(src2(Var((name i%1)(type_ I64))))))                                                                                           | (((name i%1)(type_ I64))((name sum%1)(type_ I64)))                         | (((name i%1)(type_ I64))((name sum%2)(type_ I64)))                         |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | body  | (Add((dest((name i%2)(type_ I64)))(src1(Lit 1))(src2(Var((name i%1)(type_ I64))))))                                                                                                                    | (((name i%1)(type_ I64))((name sum%2)(type_ I64)))                         | (((name sum%2)(type_ I64))((name i%2)(type_ I64)))                         |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | body  | (Branch(Uncond((block((id_hum check)(args(((name i%1)(type_ I64))((name sum%1)(type_ I64))))))(args(((name i%2)(type_ I64))((name sum%2)(type_ I64)))))))                                              | (((name sum%2)(type_ I64))((name i%2)(type_ I64)))                         | {}                                                                         |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | body  | block end                                                                                                                                                                                              | {}                                                                         | {}                                                                         |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | exit  | (block start(args(((name sum%0)(type_ I64)))))                                                                                                                                                         | {}                                                                         | (((name sum%0)(type_ I64)))                                                |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | exit  | (Return(Var((name sum%0)(type_ I64))))                                                                                                                                                                 | (((name sum%0)(type_ I64)))                                                | {}                                                                         |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      | exit  | block end                                                                                                                                                                                              | {}                                                                         | {}                                                                         |
      +-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------+----------------------------------------------------------------------------+
      |}]
;;
