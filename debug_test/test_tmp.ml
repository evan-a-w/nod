open! Core
open! Import

let map_function_roots ~f functions =
  Map.map ~f:(Function.map_root ~f) functions
;;

let test_cfg s =
  s
  |> Parser.parse_string
  |> Result.map ~f:(map_function_roots ~f:Cfg.process)
  |> function
  | Error e -> Nod_error.to_string e |> print_endline
  | Ok fns ->
    Map.iter
      fns
      ~f:(fun { Function.root = ~root:_, ~blocks:_, ~in_order:blocks; _ } ->
        Vec.iter blocks ~f:(fun block ->
          let instrs =
            Vec.to_list block.Block.instructions @ [ block.terminal ]
          in
          print_s [%message block.id_hum (instrs : Ir.t list)]))
;;

let test_ssa ?don't_opt s =
  test_cfg s;
  print_endline "=================================";
  Parser.parse_string s
  |> Result.map ~f:(map_function_roots ~f:Cfg.process)
  |> Result.map ~f:Eir.set_entry_block_args
  |> Result.map ~f:(map_function_roots ~f:Ssa.create)
  |> function
  | Error e -> Nod_error.to_string e |> print_endline
  | Ok fns ->
    let go fns =
      Map.iter fns ~f:(fun { Function.root = (ssa : Ssa.t); _ } ->
        Vec.iter ssa.in_order ~f:(fun block ->
          let instrs = Vec.to_list block.instructions @ [ block.terminal ] in
          print_s
            [%message
              block.id_hum ~args:(block.args : Var.t Vec.t) (instrs : Ir.t list)]))
    in
    go fns;
    (match don't_opt with
     | Some () -> ()
     | None ->
       print_endline "******************************";
       Eir.optimize fns;
       go fns)
;;

let compile_and_lower ?(opt_flags = Eir.Opt_flags.no_opt) program =
  match Nod.compile ~opt_flags program with
  | Error e -> Nod_error.to_string e |> print_endline
  | Ok functions ->
    let asm = X86_backend.compile_to_asm functions in
    print_endline asm
;;

let borked = Examples.Textual.fib_recursive

let%expect_test "run" =
  let output =
    compile_and_execute
      ~harness:
        (make_harness_source ~fn_name:"fib" ~fn_arg_type:"int" ~fn_arg:"5" ())
      ~opt_flags:Eir.Opt_flags.no_opt
      borked
  in
  print_endline output;
  [%expect {| 8 |}]
;;

let%expect_test "borked regaloc" =
  match Nod.compile ~opt_flags:Eir.Opt_flags.no_opt borked with
  | Error e -> Nod_error.to_string e |> print_endline
  | Ok functions ->
    X86_backend.For_testing.print_assignments functions;
    [%expect
      {|
      ((function_name fib)
       (assignments
        ((((name arg) (type_ I64)) (Reg ((reg R14) (class_ I64))))
         (((name arg1) (type_ I64)) (Reg ((reg RDI) (class_ I64))))
         (((name arg_reg) (type_ I64)) (Reg ((reg RDI) (class_ I64))))
         (((name arg_reg1) (type_ I64)) (Reg ((reg RDI) (class_ I64))))
         (((name m1) (type_ I64)) (Reg ((reg R15) (class_ I64))))
         (((name m1%0) (type_ I64)) (Reg ((reg R15) (class_ I64))))
         (((name m2) (type_ I64)) (Reg ((reg R15) (class_ I64))))
         (((name regalloc_scratch) (type_ I64)) (Reg ((reg R15) (class_ I64))))
         (((name res) (type_ I64)) (Reg ((reg R15) (class_ I64))))
         (((name res__0) (type_ I64)) (Reg ((reg RAX) (class_ I64))))
         (((name res__00) (type_ I64)) (Reg ((reg R15) (class_ I64))))
         (((name sub1_res) (type_ I64)) (Reg ((reg R13) (class_ I64))))
         (((name sub2_res) (type_ I64)) (Reg ((reg R14) (class_ I64)))))))
      ((((name arg1) (type_ I64)) ((name m1) (type_ I64)))
       (((name arg) (type_ I64)) ((name m1) (type_ I64)))
       (((name m1%0) (type_ I64)) ((name arg_reg) (type_ I64)))
       (((name m1%0) (type_ I64)) ((name sub1_res) (type_ I64)))
       (((name sub1_res) (type_ I64)) ((name m2) (type_ I64)))
       (((name sub1_res) (type_ I64)) ((name arg_reg1) (type_ I64)))
       (((name sub1_res) (type_ I64)) ((name sub2_res) (type_ I64)))
       (((name m2) (type_ I64)) ((name arg_reg1) (type_ I64)))
       (((name sub2_res) (type_ I64)) ((name res) (type_ I64))))
      |}]
;;

let%expect_test "borked" =
  compile_and_lower ~opt_flags:Eir.Opt_flags.no_opt borked;
  [%expect
    {|
    .intel_syntax noprefix
    .text
    .globl fib
    fib:
      push rbp
      push r13
      push r14
      push r15
      mov rbp, rsp
      add rbp, 32
      mov r14, rdi
    fib___root:
      cmp r14, 0
      je fib__intermediate__root_to_ret_1
    fib__intermediate__root_to_check1_:
      jmp fib__check1_
    fib__intermediate__root_to_ret_1:
      jmp fib__ret_1
    fib__check1_:
      mov r15, r14
      sub r15, 1
      cmp r15, 0
      je fib__intermediate_check1__to_ret_1
    fib__intermediate_check1__to_rec:
      jmp fib__rec
    fib__intermediate_check1__to_ret_1:
    fib__ret_1:
      mov r15, 1
      mov rax, r15
      jmp fib__fib__epilogue
    fib__rec:
      push rax
      mov rdi, r15
      call fib
      mov r13, rax
      pop rax
      sub r15, 1
      push rax
      mov rdi, r15
      call fib
      mov r14, rax
      pop rax
      mov r15, r13
      add r15, r14
      mov rax, r15
    fib__fib__epilogue:
      mov rsp, rbp
      sub rsp, 32
      pop r15
      pop r14
      pop r13
      pop rbp
      ret
    .section .note.GNU-stack,"",@progbits
    |}]
;;

let%expect_test "debug borked opt ssa" =
  test_ssa ~don't_opt:() borked;
  [%expect
    {|
    (%root
     (instrs
      ((Branch
        (Cond (cond (Var ((name arg) (type_ I64))))
         (if_true ((block ((id_hum check1_) (args ()))) (args ())))
         (if_false ((block ((id_hum ret_1) (args ()))) (args ()))))))))
    (check1_
     (instrs
      ((Sub
        ((dest ((name m1) (type_ I64))) (src1 (Var ((name arg) (type_ I64))))
         (src2 (Lit 1))))
       (Branch
        (Cond (cond (Var ((name m1) (type_ I64))))
         (if_true ((block ((id_hum rec) (args ()))) (args ())))
         (if_false ((block ((id_hum ret_1) (args ()))) (args ()))))))))
    (ret_1 (instrs ((Return (Lit 1)))))
    (rec
     (instrs
      ((Call (fn fib) (results (((name sub1_res) (type_ I64))))
        (args ((Var ((name m1) (type_ I64))))))
       (Sub
        ((dest ((name m2) (type_ I64))) (src1 (Var ((name m1) (type_ I64))))
         (src2 (Lit 1))))
       (Call (fn fib) (results (((name sub2_res) (type_ I64))))
        (args ((Var ((name m2) (type_ I64))))))
       (Add
        ((dest ((name res) (type_ I64)))
         (src1 (Var ((name sub1_res) (type_ I64))))
         (src2 (Var ((name sub2_res) (type_ I64))))))
       (Return (Var ((name res) (type_ I64)))))))
    =================================
    (%root (args (((name arg) (type_ I64))))
     (instrs
      ((Branch
        (Cond (cond (Var ((name arg) (type_ I64))))
         (if_true ((block ((id_hum check1_) (args ()))) (args ())))
         (if_false
          ((block ((id_hum ret_1) (args (((name m1) (type_ I64))))))
           (args (((name m1) (type_ I64)))))))))))
    (check1_ (args ())
     (instrs
      ((Sub
        ((dest ((name m1%0) (type_ I64))) (src1 (Var ((name arg) (type_ I64))))
         (src2 (Lit 1))))
       (Branch
        (Cond (cond (Var ((name m1%0) (type_ I64))))
         (if_true ((block ((id_hum rec) (args ()))) (args ())))
         (if_false
          ((block ((id_hum ret_1) (args (((name m1) (type_ I64))))))
           (args (((name m1%0) (type_ I64)))))))))))
    (ret_1 (args (((name m1) (type_ I64)))) (instrs ((Return (Lit 1)))))
    (rec (args ())
     (instrs
      ((Call (fn fib) (results (((name sub1_res) (type_ I64))))
        (args ((Var ((name m1%0) (type_ I64))))))
       (Sub
        ((dest ((name m2) (type_ I64))) (src1 (Var ((name m1%0) (type_ I64))))
         (src2 (Lit 1))))
       (Call (fn fib) (results (((name sub2_res) (type_ I64))))
        (args ((Var ((name m2) (type_ I64))))))
       (Add
        ((dest ((name res) (type_ I64)))
         (src1 (Var ((name sub1_res) (type_ I64))))
         (src2 (Var ((name sub2_res) (type_ I64))))))
       (Return (Var ((name res) (type_ I64)))))))
    |}]
;;

let%expect_test "debug borked" =
  match Nod.compile ~opt_flags:Eir.Opt_flags.no_opt borked with
  | Error e -> Nod_error.to_string e |> print_endline
  | Ok functions ->
    X86_backend.For_testing.print_selected_instructions functions;
    [%expect
      {|
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | block                         | instruction                                                                                                                                                                                                                                              | live_in                                                    | live_out                                                   |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__prologue                 | (block start(args(((name arg1)(type_ I64)))))                                                                                                                                                                                                            | (((name m1)(type_ I64)))                                   | (((name m1)(type_ I64)))                                   |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__prologue                 | (X86(MOV(Reg((reg(Allocated((name arg1)(type_ I64))(RDI)))(class_ I64)))(Reg((reg RDI)(class_ I64)))))                                                                                                                                                   | (((name m1)(type_ I64)))                                   | (((name arg1)(type_ I64))((name m1)(type_ I64)))           |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__prologue                 | (X86(Tag_def NOOP(Reg((reg RBP)(class_ I64)))))                                                                                                                                                                                                          | (((name arg1)(type_ I64))((name m1)(type_ I64)))           | (((name arg1)(type_ I64))((name m1)(type_ I64)))           |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__prologue                 | (X86(MOV(Reg((reg(Unallocated((name arg)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name arg1)(type_ I64))))(class_ I64)))))                                                                                                                      | (((name arg1)(type_ I64))((name m1)(type_ I64)))           | (((name arg1)(type_ I64))((name m1)(type_ I64)))           |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__prologue                 | (X86(JMP((block((id_hum %root)(args(((name arg)(type_ I64))))))(args(((name arg1)(type_ I64)))))))                                                                                                                                                       | (((name arg1)(type_ I64))((name m1)(type_ I64)))           | (((name m1)(type_ I64)))                                   |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__prologue                 | block end                                                                                                                                                                                                                                                | (((name m1)(type_ I64)))                                   | (((name m1)(type_ I64)))                                   |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | %root                         | (block start(args(((name arg)(type_ I64)))))                                                                                                                                                                                                             | (((name m1)(type_ I64)))                                   | (((name arg)(type_ I64))((name m1)(type_ I64)))            |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | %root                         | (X86_terminal((CMP(Reg((reg(Unallocated((name arg)(type_ I64))))(class_ I64)))(Imm 0))(JNE((block((id_hum intermediate_%root_to_check1_)(args())))(args()))(((block((id_hum intermediate_%root_to_ret_1)(args())))(args(((name m1)(type_ I64)))))))))    | (((name arg)(type_ I64))((name m1)(type_ I64)))            | (((name arg)(type_ I64))((name m1)(type_ I64)))            |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | %root                         | block end                                                                                                                                                                                                                                                | (((name arg)(type_ I64))((name m1)(type_ I64)))            | (((name arg)(type_ I64))((name m1)(type_ I64)))            |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_check1_ | (block start(args()))                                                                                                                                                                                                                                    | (((name arg)(type_ I64)))                                  | (((name arg)(type_ I64)))                                  |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_check1_ | (X86(JMP((block((id_hum check1_)(args())))(args()))))                                                                                                                                                                                                    | (((name arg)(type_ I64)))                                  | (((name arg)(type_ I64)))                                  |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_check1_ | block end                                                                                                                                                                                                                                                | (((name arg)(type_ I64)))                                  | (((name arg)(type_ I64)))                                  |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | check1_                       | (block start(args()))                                                                                                                                                                                                                                    | (((name arg)(type_ I64)))                                  | (((name arg)(type_ I64)))                                  |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | check1_                       | (X86(MOV(Reg((reg(Unallocated((name m1%0)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name arg)(type_ I64))))(class_ I64)))))                                                                                                                      | (((name arg)(type_ I64)))                                  | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | check1_                       | (X86(SUB(Reg((reg(Unallocated((name m1%0)(type_ I64))))(class_ I64)))(Imm 1)))                                                                                                                                                                           | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | check1_                       | (X86_terminal((CMP(Reg((reg(Unallocated((name m1%0)(type_ I64))))(class_ I64)))(Imm 0))(JNE((block((id_hum intermediate_check1__to_rec)(args())))(args()))(((block((id_hum intermediate_check1__to_ret_1)(args())))(args(((name m1%0)(type_ I64))))))))) | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | check1_                       | block end                                                                                                                                                                                                                                                | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_check1__to_rec   | (block start(args()))                                                                                                                                                                                                                                    | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_check1__to_rec   | (X86(JMP((block((id_hum rec)(args())))(args()))))                                                                                                                                                                                                        | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_check1__to_rec   | block end                                                                                                                                                                                                                                                | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (block start(args()))                                                                                                                                                                                                                                    | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | {X86,Save_clobbers}                                                                                                                                                                                                                                      | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(MOV(Reg((reg(Allocated((name arg_reg)(type_ I64))(RDI)))(class_ I64)))(Reg((reg(Unallocated((name m1%0)(type_ I64))))(class_ I64)))))                                                                                                               | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(CALL(fn fib)(results(((reg(Unallocated((name sub1_res)(type_ I64))))(class_ I64))))(args((Reg((reg(Unallocated((name m1%0)(type_ I64))))(class_ I64)))))))                                                                                          | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(MOV(Reg((reg(Unallocated((name sub1_res)(type_ I64))))(class_ I64)))(Reg((reg RAX)(class_ I64)))))                                                                                                                                                  | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64))((name sub1_res)(type_ I64)))     |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | {X86,Restore_clobbers}                                                                                                                                                                                                                                   | (((name m1%0)(type_ I64))((name sub1_res)(type_ I64)))     | (((name m1%0)(type_ I64))((name sub1_res)(type_ I64)))     |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(MOV(Reg((reg(Unallocated((name m2)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name m1%0)(type_ I64))))(class_ I64)))))                                                                                                                       | (((name m1%0)(type_ I64))((name sub1_res)(type_ I64)))     | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(SUB(Reg((reg(Unallocated((name m2)(type_ I64))))(class_ I64)))(Imm 1)))                                                                                                                                                                             | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | {X86,Save_clobbers}                                                                                                                                                                                                                                      | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(MOV(Reg((reg(Allocated((name arg_reg1)(type_ I64))(RDI)))(class_ I64)))(Reg((reg(Unallocated((name m2)(type_ I64))))(class_ I64)))))                                                                                                                | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(CALL(fn fib)(results(((reg(Unallocated((name sub2_res)(type_ I64))))(class_ I64))))(args((Reg((reg(Unallocated((name m2)(type_ I64))))(class_ I64)))))))                                                                                            | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       | (((name sub1_res)(type_ I64)))                             |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(MOV(Reg((reg(Unallocated((name sub2_res)(type_ I64))))(class_ I64)))(Reg((reg RAX)(class_ I64)))))                                                                                                                                                  | (((name sub1_res)(type_ I64)))                             | (((name sub1_res)(type_ I64))((name sub2_res)(type_ I64))) |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | {X86,Restore_clobbers}                                                                                                                                                                                                                                   | (((name sub1_res)(type_ I64))((name sub2_res)(type_ I64))) | (((name sub1_res)(type_ I64))((name sub2_res)(type_ I64))) |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(MOV(Reg((reg(Unallocated((name res)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name sub1_res)(type_ I64))))(class_ I64)))))                                                                                                                  | (((name sub1_res)(type_ I64))((name sub2_res)(type_ I64))) | (((name sub2_res)(type_ I64))((name res)(type_ I64)))      |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(ADD(Reg((reg(Unallocated((name res)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name sub2_res)(type_ I64))))(class_ I64)))))                                                                                                                  | (((name sub2_res)(type_ I64))((name res)(type_ I64)))      | (((name res)(type_ I64)))                                  |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(MOV(Reg((reg(Unallocated((name res__0)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name res)(type_ I64))))(class_ I64)))))                                                                                                                    | (((name res)(type_ I64)))                                  | (((name res)(type_ I64)))                                  |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86_terminal((JMP((block((id_hum fib__epilogue)(args(((name res__0)(type_ I64))))))(args(((name res)(type_ I64))))))))                                                                                                                                  | (((name res)(type_ I64)))                                  | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | block end                                                                                                                                                                                                                                                | {}                                                         | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__epilogue                 | (block start(args(((name res__0)(type_ I64)))))                                                                                                                                                                                                          | {}                                                         | (((name res__0)(type_ I64)))                               |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__epilogue                 | (X86(MOV(Reg((reg RAX)(class_ I64)))(Reg((reg(Allocated((name res__0)(type_ I64))(RAX)))(class_ I64)))))                                                                                                                                                 | (((name res__0)(type_ I64)))                               | (((name res__0)(type_ I64)))                               |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__epilogue                 | (X86(RET((Reg((reg(Allocated((name res__0)(type_ I64))(RAX)))(class_ I64))))))                                                                                                                                                                           | (((name res__0)(type_ I64)))                               | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__epilogue                 | block end                                                                                                                                                                                                                                                | {}                                                         | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_check1__to_ret_1 | (block start(args()))                                                                                                                                                                                                                                    | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_check1__to_ret_1 | (X86(MOV(Reg((reg(Unallocated((name m1)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name m1%0)(type_ I64))))(class_ I64)))))                                                                                                                       | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_check1__to_ret_1 | (X86(JMP((block((id_hum ret_1)(args(((name m1)(type_ I64))))))(args(((name m1%0)(type_ I64)))))))                                                                                                                                                        | (((name m1%0)(type_ I64)))                                 | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_check1__to_ret_1 | block end                                                                                                                                                                                                                                                | {}                                                         | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | ret_1                         | (block start(args(((name m1)(type_ I64)))))                                                                                                                                                                                                              | {}                                                         | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | ret_1                         | (X86(MOV(Reg((reg(Unallocated((name res__00)(type_ I64))))(class_ I64)))(Imm 1)))                                                                                                                                                                        | {}                                                         | (((name res__00)(type_ I64)))                              |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | ret_1                         | (X86(MOV(Reg((reg(Unallocated((name res__0)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name res__00)(type_ I64))))(class_ I64)))))                                                                                                                | (((name res__00)(type_ I64)))                              | (((name res__00)(type_ I64)))                              |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | ret_1                         | (X86_terminal((JMP((block((id_hum fib__epilogue)(args(((name res__0)(type_ I64))))))(args(((name res__00)(type_ I64))))))))                                                                                                                              | (((name res__00)(type_ I64)))                              | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | ret_1                         | block end                                                                                                                                                                                                                                                | {}                                                         | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_ret_1   | (block start(args()))                                                                                                                                                                                                                                    | (((name m1)(type_ I64)))                                   | (((name m1)(type_ I64)))                                   |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_ret_1   | (X86(MOV(Reg((reg(Unallocated((name regalloc_scratch)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name m1)(type_ I64))))(class_ I64)))))                                                                                                           | (((name m1)(type_ I64)))                                   | (((name regalloc_scratch)(type_ I64)))                     |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_ret_1   | (X86(MOV(Reg((reg(Unallocated((name m1)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name regalloc_scratch)(type_ I64))))(class_ I64)))))                                                                                                           | (((name regalloc_scratch)(type_ I64)))                     | (((name m1)(type_ I64)))                                   |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_ret_1   | (X86(JMP((block((id_hum ret_1)(args(((name m1)(type_ I64))))))(args(((name m1)(type_ I64)))))))                                                                                                                                                          | (((name m1)(type_ I64)))                                   | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_ret_1   | block end                                                                                                                                                                                                                                                | {}                                                         | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      |}]
;;

let%expect_test "debug borked opt" =
  match Nod.compile ~opt_flags:Eir.Opt_flags.default borked with
  | Error e -> Nod_error.to_string e |> print_endline
  | Ok functions ->
    X86_backend.For_testing.print_selected_instructions functions;
    [%expect
      {|
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | block                         | instruction                                                                                                                                                                                                                                              | live_in                                                    | live_out                                                   |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__prologue                 | (block start(args(((name arg1)(type_ I64)))))                                                                                                                                                                                                            | (((name m1)(type_ I64)))                                   | (((name m1)(type_ I64)))                                   |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__prologue                 | (X86(MOV(Reg((reg(Allocated((name arg1)(type_ I64))(RDI)))(class_ I64)))(Reg((reg RDI)(class_ I64)))))                                                                                                                                                   | (((name m1)(type_ I64)))                                   | (((name arg1)(type_ I64))((name m1)(type_ I64)))           |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__prologue                 | (X86(Tag_def NOOP(Reg((reg RBP)(class_ I64)))))                                                                                                                                                                                                          | (((name arg1)(type_ I64))((name m1)(type_ I64)))           | (((name arg1)(type_ I64))((name m1)(type_ I64)))           |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__prologue                 | (X86(MOV(Reg((reg(Unallocated((name arg)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name arg1)(type_ I64))))(class_ I64)))))                                                                                                                      | (((name arg1)(type_ I64))((name m1)(type_ I64)))           | (((name arg1)(type_ I64))((name m1)(type_ I64)))           |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__prologue                 | (X86(JMP((block((id_hum %root)(args(((name arg)(type_ I64))))))(args(((name arg1)(type_ I64)))))))                                                                                                                                                       | (((name arg1)(type_ I64))((name m1)(type_ I64)))           | (((name m1)(type_ I64)))                                   |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__prologue                 | block end                                                                                                                                                                                                                                                | (((name m1)(type_ I64)))                                   | (((name m1)(type_ I64)))                                   |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | %root                         | (block start(args(((name arg)(type_ I64)))))                                                                                                                                                                                                             | (((name m1)(type_ I64)))                                   | (((name arg)(type_ I64))((name m1)(type_ I64)))            |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | %root                         | (X86_terminal((CMP(Reg((reg(Unallocated((name arg)(type_ I64))))(class_ I64)))(Imm 0))(JNE((block((id_hum intermediate_%root_to_check1_)(args())))(args()))(((block((id_hum intermediate_%root_to_ret_1)(args())))(args(((name m1)(type_ I64)))))))))    | (((name arg)(type_ I64))((name m1)(type_ I64)))            | (((name arg)(type_ I64))((name m1)(type_ I64)))            |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | %root                         | block end                                                                                                                                                                                                                                                | (((name arg)(type_ I64))((name m1)(type_ I64)))            | (((name arg)(type_ I64))((name m1)(type_ I64)))            |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_check1_ | (block start(args()))                                                                                                                                                                                                                                    | (((name arg)(type_ I64)))                                  | (((name arg)(type_ I64)))                                  |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_check1_ | (X86(JMP((block((id_hum check1_)(args())))(args()))))                                                                                                                                                                                                    | (((name arg)(type_ I64)))                                  | (((name arg)(type_ I64)))                                  |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_check1_ | block end                                                                                                                                                                                                                                                | (((name arg)(type_ I64)))                                  | (((name arg)(type_ I64)))                                  |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | check1_                       | (block start(args()))                                                                                                                                                                                                                                    | (((name arg)(type_ I64)))                                  | (((name arg)(type_ I64)))                                  |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | check1_                       | (X86(MOV(Reg((reg(Unallocated((name m1%0)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name arg)(type_ I64))))(class_ I64)))))                                                                                                                      | (((name arg)(type_ I64)))                                  | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | check1_                       | (X86(SUB(Reg((reg(Unallocated((name m1%0)(type_ I64))))(class_ I64)))(Imm 1)))                                                                                                                                                                           | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | check1_                       | (X86_terminal((CMP(Reg((reg(Unallocated((name m1%0)(type_ I64))))(class_ I64)))(Imm 0))(JNE((block((id_hum intermediate_check1__to_rec)(args())))(args()))(((block((id_hum intermediate_check1__to_ret_1)(args())))(args(((name m1%0)(type_ I64))))))))) | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | check1_                       | block end                                                                                                                                                                                                                                                | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_check1__to_rec   | (block start(args()))                                                                                                                                                                                                                                    | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_check1__to_rec   | (X86(JMP((block((id_hum rec)(args())))(args()))))                                                                                                                                                                                                        | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_check1__to_rec   | block end                                                                                                                                                                                                                                                | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (block start(args()))                                                                                                                                                                                                                                    | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | {X86,Save_clobbers}                                                                                                                                                                                                                                      | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(MOV(Reg((reg(Allocated((name arg_reg)(type_ I64))(RDI)))(class_ I64)))(Reg((reg(Unallocated((name m1%0)(type_ I64))))(class_ I64)))))                                                                                                               | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(CALL(fn fib)(results(((reg(Unallocated((name sub1_res)(type_ I64))))(class_ I64))))(args((Reg((reg(Unallocated((name m1%0)(type_ I64))))(class_ I64)))))))                                                                                          | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(MOV(Reg((reg(Unallocated((name sub1_res)(type_ I64))))(class_ I64)))(Reg((reg RAX)(class_ I64)))))                                                                                                                                                  | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64))((name sub1_res)(type_ I64)))     |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | {X86,Restore_clobbers}                                                                                                                                                                                                                                   | (((name m1%0)(type_ I64))((name sub1_res)(type_ I64)))     | (((name m1%0)(type_ I64))((name sub1_res)(type_ I64)))     |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(MOV(Reg((reg(Unallocated((name m2)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name m1%0)(type_ I64))))(class_ I64)))))                                                                                                                       | (((name m1%0)(type_ I64))((name sub1_res)(type_ I64)))     | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(SUB(Reg((reg(Unallocated((name m2)(type_ I64))))(class_ I64)))(Imm 1)))                                                                                                                                                                             | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | {X86,Save_clobbers}                                                                                                                                                                                                                                      | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(MOV(Reg((reg(Allocated((name arg_reg1)(type_ I64))(RDI)))(class_ I64)))(Reg((reg(Unallocated((name m2)(type_ I64))))(class_ I64)))))                                                                                                                | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(CALL(fn fib)(results(((reg(Unallocated((name sub2_res)(type_ I64))))(class_ I64))))(args((Reg((reg(Unallocated((name m2)(type_ I64))))(class_ I64)))))))                                                                                            | (((name sub1_res)(type_ I64))((name m2)(type_ I64)))       | (((name sub1_res)(type_ I64)))                             |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(MOV(Reg((reg(Unallocated((name sub2_res)(type_ I64))))(class_ I64)))(Reg((reg RAX)(class_ I64)))))                                                                                                                                                  | (((name sub1_res)(type_ I64)))                             | (((name sub1_res)(type_ I64))((name sub2_res)(type_ I64))) |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | {X86,Restore_clobbers}                                                                                                                                                                                                                                   | (((name sub1_res)(type_ I64))((name sub2_res)(type_ I64))) | (((name sub1_res)(type_ I64))((name sub2_res)(type_ I64))) |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(MOV(Reg((reg(Unallocated((name res)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name sub1_res)(type_ I64))))(class_ I64)))))                                                                                                                  | (((name sub1_res)(type_ I64))((name sub2_res)(type_ I64))) | (((name sub2_res)(type_ I64))((name res)(type_ I64)))      |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(ADD(Reg((reg(Unallocated((name res)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name sub2_res)(type_ I64))))(class_ I64)))))                                                                                                                  | (((name sub2_res)(type_ I64))((name res)(type_ I64)))      | (((name res)(type_ I64)))                                  |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86(MOV(Reg((reg(Unallocated((name res__0)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name res)(type_ I64))))(class_ I64)))))                                                                                                                    | (((name res)(type_ I64)))                                  | (((name res)(type_ I64)))                                  |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | (X86_terminal((JMP((block((id_hum fib__epilogue)(args(((name res__0)(type_ I64))))))(args(((name res)(type_ I64))))))))                                                                                                                                  | (((name res)(type_ I64)))                                  | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | rec                           | block end                                                                                                                                                                                                                                                | {}                                                         | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__epilogue                 | (block start(args(((name res__0)(type_ I64)))))                                                                                                                                                                                                          | {}                                                         | (((name res__0)(type_ I64)))                               |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__epilogue                 | (X86(MOV(Reg((reg RAX)(class_ I64)))(Reg((reg(Allocated((name res__0)(type_ I64))(RAX)))(class_ I64)))))                                                                                                                                                 | (((name res__0)(type_ I64)))                               | (((name res__0)(type_ I64)))                               |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__epilogue                 | (X86(RET((Reg((reg(Allocated((name res__0)(type_ I64))(RAX)))(class_ I64))))))                                                                                                                                                                           | (((name res__0)(type_ I64)))                               | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | fib__epilogue                 | block end                                                                                                                                                                                                                                                | {}                                                         | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_check1__to_ret_1 | (block start(args()))                                                                                                                                                                                                                                    | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_check1__to_ret_1 | (X86(MOV(Reg((reg(Unallocated((name m1)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name m1%0)(type_ I64))))(class_ I64)))))                                                                                                                       | (((name m1%0)(type_ I64)))                                 | (((name m1%0)(type_ I64)))                                 |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_check1__to_ret_1 | (X86(JMP((block((id_hum ret_1)(args(((name m1)(type_ I64))))))(args(((name m1%0)(type_ I64)))))))                                                                                                                                                        | (((name m1%0)(type_ I64)))                                 | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_check1__to_ret_1 | block end                                                                                                                                                                                                                                                | {}                                                         | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | ret_1                         | (block start(args(((name m1)(type_ I64)))))                                                                                                                                                                                                              | {}                                                         | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | ret_1                         | (X86(MOV(Reg((reg(Unallocated((name res__00)(type_ I64))))(class_ I64)))(Imm 1)))                                                                                                                                                                        | {}                                                         | (((name res__00)(type_ I64)))                              |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | ret_1                         | (X86(MOV(Reg((reg(Unallocated((name res__0)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name res__00)(type_ I64))))(class_ I64)))))                                                                                                                | (((name res__00)(type_ I64)))                              | (((name res__00)(type_ I64)))                              |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | ret_1                         | (X86_terminal((JMP((block((id_hum fib__epilogue)(args(((name res__0)(type_ I64))))))(args(((name res__00)(type_ I64))))))))                                                                                                                              | (((name res__00)(type_ I64)))                              | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | ret_1                         | block end                                                                                                                                                                                                                                                | {}                                                         | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_ret_1   | (block start(args()))                                                                                                                                                                                                                                    | (((name m1)(type_ I64)))                                   | (((name m1)(type_ I64)))                                   |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_ret_1   | (X86(MOV(Reg((reg(Unallocated((name regalloc_scratch)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name m1)(type_ I64))))(class_ I64)))))                                                                                                           | (((name m1)(type_ I64)))                                   | (((name regalloc_scratch)(type_ I64)))                     |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_ret_1   | (X86(MOV(Reg((reg(Unallocated((name m1)(type_ I64))))(class_ I64)))(Reg((reg(Unallocated((name regalloc_scratch)(type_ I64))))(class_ I64)))))                                                                                                           | (((name regalloc_scratch)(type_ I64)))                     | (((name m1)(type_ I64)))                                   |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_ret_1   | (X86(JMP((block((id_hum ret_1)(args(((name m1)(type_ I64))))))(args(((name m1)(type_ I64)))))))                                                                                                                                                          | (((name m1)(type_ I64)))                                   | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      | intermediate_%root_to_ret_1   | block end                                                                                                                                                                                                                                                | {}                                                         | {}                                                         |
      +-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------+------------------------------------------------------------+
      |}]
;;
